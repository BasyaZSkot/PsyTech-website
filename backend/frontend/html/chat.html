{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{% static 'css/chat.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="icon" style="font-size: 25;" href="{% static 'lamp 2.0.svg' %}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Maname&display=swap" rel="stylesheet">
    <title>{{ chat.chat_name }}</title>
</head>
<body>
    <h1 style="margin-left: 25px; margin-top: 30px; position: relative; color: white;">{{ recipient }}:</h1>
    <ul id="scrollableContainer" class="messages">
        {% for message in messages %}
            {% if message.sender == user %}
            <li id="{{ message.id }}" class="sender">
                <p id="message">{{ message.content }}</p>
                <div id="message-info">
                    {% if message.timestamp.minute < 10 %}
                        <p id="timestamp">{{ message.timestamp.hour }}. 0{{ message.timestamp.minute }}</p>
                    {% else %}
                        <p id="timestamp">{{ message.timestamp.hour }}. {{ message.timestamp.minute }}</p>
                    {% endif %}
                    {% if message.read_status %}
                        <i id="double-check" class="fa-solid fa-check-double"></i>
                    {% else %}
                        <i id="check" class="fa-solid fa-check"></i>
                    {% endif %}
                </div>
            </li>
            
            {% else %}
                {% if message.read_status == True %}
                    <li id="{{ message.id }}" class="recipient read">
                        <p id="message">{{ message.content }}</p>
                        <div id="message-info">
                            <p id="recip">{{ recipient }}</p>
                            {% if message.timestamp.minute < 10 %}
                                <p id="timestamp">{{ message.timestamp.hour }}. 0{{ message.timestamp.minute }}</p>
                            {% else %}
                                <p id="timestamp">{{ message.timestamp.hour }}. {{ message.timestamp.minute }}</p>
                            {% endif %}
                        </div>
                    </li><br>
                {% else %}
                    <li id="{{ message.id }}" class="recipient unread">
                        <p id="message">{{ message.content }}</p>
                        <div id="message-info">
                            <p id="recip">{{ recipient }}</p>
                            {% if message.timestamp.minute < 10 %}
                                <p id="timestamp">{{ message.timestamp.hour }}.0{{ message.timestamp.minute }}</p>
                            {% else %}
                                <p id="timestamp">{{ message.timestamp.hour }}.{{ message.timestamp.minute }}</p>
                            {% endif %}
                        </div>
                    </li><br>
                {% endif %}
            {% endif %}
        {% endfor %}
    </ul>
    <form autocomplete="off" method="post" id="message-form"  class="message-input-container">
        {% csrf_token %}
        <div id="errorMessage">
            <p>You have exceeded the character limit!</p>
        </div>
        <input onkeydown="countSimboles()" name="message" class="message-input" id="textInput" placeholder="Enter message"></input>
        <span id="charCount" style="color: white; margin-left: 20px; font-size: 20px;">0/500</span>

        <button type="submit" id="send" style="margin-left: 10px; background: none; border: none;"><i class="fa-solid fa-paper-plane fa-2xl" style="color: #74C0FC;"></i></button>
    </form>

    <script>
        var csrf = document.getElementsByName('csrfmiddlewaretoken')[0].value
        const textInput = document.getElementById('textInput');
        const charCount = document.getElementById('charCount');
        const errorMessage = document.getElementById('errorMessage');
        const maxLength = 500;
        const container = document.getElementById('scrollableContainer');
        const visibleElements = getVisibleElements(container);
        if (visibleElements != []){
            changeReadStatus(visibleElements)
        };
        
        window.onload = function() {
            var container = document.getElementById('scrollableContainer');
            container.scrollTop = container.scrollHeight;
            document.getElementById("textInput").focus();
        };

        function countSimboles() {
            const currentLength = textInput.value.length;
            charCount.textContent = `${currentLength}/${maxLength}`;

            if (currentLength > maxLength) {
                errorMessage.style.display = 'block';
                textInput.value = textInput.value.substring(0, maxLength);
                charCount.textContent = `${maxLength}/${maxLength}`;
            } else {
                errorMessage.style.display = 'none';
            };
        }

        // function saveObject(element) {
        //     $.ajax({
        //         type: "POST",
        //         url: "{% url 'save' %}",   
        //         data: {csrfmiddlewaretoken: csrf,
        //                model_id: element.id
        //             },
        //         success:  function(response){
        //             alert(response);
        //         }
        //     });
        // }
        
        // function changeReadStatus(elements){
        //     elements.forEach(element => {
        //         const error = saveObject(element);
        //         console.log(error)
        //         element.className = "recipient read";
        //     });
        // };

        function handleEnterPress(event) {
            if (event.keyCode === 13) {
                var button = document.getElementById("send");
                button.click();
            
            };
        };

        // function getVisibleElements(container) {
        //     const containerRect = container.getBoundingClientRect();
        //     const elements = container.children;
        //     const visibleElements = [];

        //     for (let element of elements) {
        //         const elementRect = element.getBoundingClientRect();

        //         if (
        //             elementRect.top >= containerRect.top &&
        //             elementRect.bottom <= containerRect.bottom &&
        //             elementRect.left >= containerRect.left &&
        //             elementRect.right <= containerRect.right
        //         ) {
        //             if (element.className === "recipient unread"){
        //                 visibleElements.push(element);
        //             };
        //         };
        //     };

        //     return visibleElements;
        // };

        textInput.addEventListener("keydown", handleEnterPress);
        
        // container.addEventListener('scroll', () => {
        //     const visibleElements = getVisibleElements(container);
        //     if (visibleElements != []){
        //         changeReadStatus(visibleElements)
        //     };
        // });

        

        textInput.addEventListener('input', countSimboles);

    </script>
    <script>
        function scrollToBottom() {
            var chatContainer = document.getElementById("chatContainer");
            chatContainer.scrollTop = chatContainer.scrollHeight;
        };
        // Determine the WebSocket protocol based on the application's URL
        const websocketProtocol = window.location.protocol === "https:" ? "wss" : "ws";
        const wsEndpoint = `${websocketProtocol}://${window.location.host}/ws/notification/{{room_name}}/`;
    
        // Create a new WebSocket connection
        const socket = new WebSocket(wsEndpoint);
    
        // Successful connection event
        socket.onopen = (event) => {
            console.log("WebSocket connection opened!");
        };
    
        // Socket disconnect event
        socket.onclose = (event) => {
            console.log("WebSocket connection closed!");
        };
    
        // Form submit listener
        document.getElementById('message-form').addEventListener('submit', function(event){
            event.preventDefault();
            const message = document.getElementById('msg').value;
            socket.send(
                JSON.stringify({
                    'message': message,
                    'chat_name': '{{chat.chat_name}}',
                    'sender': '{{user}}',
                })
            );
        });
    
        // Response from consumer on the server
        socket.addEventListener("message", (event) => {
            const messageData = JSON.parse(event.data)['message'];
            console.log(messageData);
    
            var sender = messageData['sender'];
            var message = messageData['message'];
    
            // Empty the message input field after the message has been sent
            if (sender == '{{user}}'){
                document.getElementById('msg').value = '';
            }
    
            // Append the message to the chatbox
            var messageDiv = document.querySelector('.message');
            if (sender != '{{user}}') { // Assuming you have a variable `currentUser` to hold the current user's name
                messageDiv.innerHTML += '<div class="receive"><p style="color: #000;">' + message + '<strong>-' + sender + '</strong></p></div>';
            } else {
                messageDiv.innerHTML += '<div class="send"><p style="color: #000;">' + message + '</p></div>';
            }
            scrollToBottom();
        });
    </script>
</body>
</html>
